<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üë§ Trang Ch·ªß B·ªánh Nh√¢n</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #333;
      overflow-x: hidden;
    }

    .header {
      background: linear-gradient(135deg, #007bff, #00c4b4);
      color: white;
      padding: 12px 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: visible;
    }

    .header h1 { margin: 0; font-size: 36px; font-weight: bold; }
    .header p { margin: 10px 0 0; font-size: 18px; opacity: 0.9; }

    .header-actions {
      position: absolute;
      top: 20px;
      right: 25px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-info {
      font-size: 14px;
      color: #fff;
      background: rgba(255,255,255,0.15);
      padding: 6px 12px;
      border-radius: 20px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-icon {
      font-size: 20px;
      background: transparent;
      color: white;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, transform 0.2s;
      position: relative;
    }

    .action-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

    .notification-badge {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #dc3545;
      color: white;
      border-radius: 50%;
      padding: 4px 7px;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      line-height: 1;
    }

    .user-menu, .notification-menu { position: relative; }
    .dropdown {
      display: none;
      position: absolute;
      right: 0;
      background: white;
      color: #333;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      margin-top: 10px;
      min-width: 200px;
      z-index: 999;
    }

    .dropdown-item {
      display: block;
      padding: 10px 15px;
      text-decoration: none;
      color: #333;
      transition: background 0.3s;
    }

    .dropdown a.dropdown-item:hover { background: #f1f1f1; }
    .dropdown .dropdown-header { font-weight: bold; padding: 10px 15px; border-bottom: 1px solid #eee; color: #007bff; }

    .user-menu.active .dropdown,
    .notification-menu.active .dropdown { display: block; }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .welcome-section {
      background-color: #ffffff;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: 40px;
      text-align: center;
      margin-bottom: 40px;
      animation: fadeIn 1s ease-in;
    }

    .welcome-section h2 { font-size: 28px; color: #007bff; margin-bottom: 15px; }
    .welcome-section p { font-size: 16px; color: #6c757d; max-width: 700px; margin: 0 auto 20px; line-height: 1.6; }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: linear-gradient(135deg, #28a745, #34c759);
      color: white;
      border: none;
      padding: 15px 35px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .action-btn:hover { background: linear-gradient(135deg, #218838, #2db84c); transform: scale(1.05); }

    .footer {
      background: linear-gradient(135deg, #007bff, #00c4b4);
      color: white;
      text-align: center;
      padding: 30px;
      margin-top: 50px;
      font-size: 14px;
      line-height: 1.6;
    }

    /* üîπ Modal l·ªãch kh√°m */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      animation: fadeIn 0.5s ease;
    }

    .modal h3 { margin-top: 0; color: #007bff; }
    .close-btn {
      float: right;
      font-size: 20px;
      cursor: pointer;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th { background: #007bff; color: white; }
    tr:hover { background-color: #f2f2f2; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>B·ªánh Vi·ªán ABCD</h1>
    <p>ChƒÉm s√≥c s·ª©c kh·ªèe c·ªßa b·∫°n v·ªõi s·ª± t·∫≠n t√¢m v√† chuy√™n nghi·ªáp</p>

    <div class="header-actions">
      <div class="user-info" id="userInfo">üë§ ƒêang t·∫£i...</div>

      <div class="notification-menu">
        <div class="action-icon notification-icon">
          üîî
              <span class="notification-badge">0</span> <!-- ‚úÖ th√™m d√≤ng n√†y -->

        </div>
        <div class="dropdown notification-dropdown" id="notificationDropdown">
          <div class="dropdown-header">üîî Th√¥ng b√°o m·ªõi</div>
          <div id="notificationList"></div>
          <a href="#" class="dropdown-item" style="text-align:center; font-size:12px; color:#007bff;">Xem t·∫•t c·∫£</a>
        </div>
      </div>

      <div class="user-menu">
        <div class="action-icon user-icon">‚öôÔ∏è</div>
        <div class="dropdown">
          <a href="#" class="dropdown-item">C·∫≠p nh·∫≠t th√¥ng tin</a>
          <a href="#" class="dropdown-item" onclick="logout()">ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="welcome-section">
      <h2>Ch√†o m·ª´ng b·∫°n!</h2>
      <p>V·ªõi h·ªá th·ªëng qu·∫£n l√Ω b·ªánh vi·ªán hi·ªán ƒë·∫°i, ch√∫ng t√¥i mang ƒë·∫øn tr·∫£i nghi·ªám chƒÉm s√≥c s·ª©c kh·ªèe ti·ªán l·ª£i, an to√†n v√† th√¢n thi·ªán.</p>
      <div class="action-buttons">
        <button class="action-btn" onclick="startBooking()">üìÖ ƒê·∫∑t L·ªãch Kh√°m Ngay</button>
        <button class="action-btn" onclick="openAppointments()">üìñ Xem L·ªãch Kh√°m</button>
      </div>
    </div>
  </div>

  <!-- üîπ Modal xem l·ªãch kh√°m -->
  <div id="appointmentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAppointments()">&times;</span>
      <h3>üìã L·ªãch Kh√°m C·ªßa T√¥i</h3>
      <table id="appointmentTable">
        <thead>
          <tr>
            <th>M√£</th>
            <th>Ng√†y gi·ªù</th>
            <th>B√°c sƒ©</th>
            <th>Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <p>&copy; 2025 B·ªánh Vi·ªán XYZ. M·ªçi quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
    <p>Li√™n h·ªá: <a href="tel:0915737863">0915737863</a> | Email: <a href="mailto:support@benhvienxyz.vn">support@benhvienxyz.vn</a></p>
    <p>ƒê·ªãa ch·ªâ: 123 ƒê∆∞·ªùng Y√™n Tr√°c, Y√™n Nghƒ©a, H√† N·ªôi</p>
  </div>

  <script>
    // ‚úÖ Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    document.addEventListener("DOMContentLoaded", () => {
      const userId = localStorage.getItem("userId");
      const username = localStorage.getItem("username");
      const role = localStorage.getItem("role");

      if (!userId || !username || !role) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
        window.location.href = "/login";
        return;
      }

      document.getElementById("userInfo").innerHTML = `üë§ <strong>${username}</strong> (${role})`;
      document.querySelector(".welcome-section h2").textContent = `Ch√†o m·ª´ng ${username}! üëã`;
    });

    // ‚úÖ ƒêƒÉng xu·∫•t
    function logout() {
      localStorage.clear();
      alert("ƒê√£ ƒëƒÉng xu·∫•t!");
      window.location.href = "/login";
    }

    // ‚úÖ Dropdown
    document.addEventListener("DOMContentLoaded", function() {
      const userMenu = document.querySelector(".user-menu");
      const userIcon = document.querySelector(".user-icon");
      const notificationMenu = document.querySelector(".notification-menu");
      const notificationIcon = document.querySelector(".notification-icon");

      userIcon.onclick = (e) => {
        e.stopPropagation();
        notificationMenu.classList.remove("active");
        userMenu.classList.toggle("active");
      };

      notificationIcon.onclick = (e) => {
        e.stopPropagation();
        userMenu.classList.remove("active");
        notificationMenu.classList.toggle("active");
        document.querySelector(".notification-badge").style.display = "none";
      };

      document.addEventListener("click", (e) => {
        if (!userMenu.contains(e.target) && !notificationMenu.contains(e.target)) {
          userMenu.classList.remove("active");
          notificationMenu.classList.remove("active");
        }
      });
    });

    // ‚úÖ Chuy·ªÉn sang trang ƒë·∫∑t l·ªãch
    function startBooking() {
      window.location.href = "./khoa";
    }

    // ‚úÖ Modal xem l·ªãch kh√°m
    async function openAppointments() {
      const modal = document.getElementById("appointmentModal");
      modal.style.display = "flex";

      const userId = localStorage.getItem("userId");
      const patientRes = await fetch("http://localhost:8080/user-service/api/patients");
      const patients = await patientRes.json();
      const patient = patients.find(p => p.userId === userId);

      if (!patient) {
        alert("Kh√¥ng t√¨m th·∫•y h·ªì s∆° b·ªánh nh√¢n!");
        return;
      }

      const apptRes = await fetch(`http://localhost:8080/appointment-service/api/appointments/patient/${patient.id}`);
      const appointments = await apptRes.json();

      const tbody = document.querySelector("#appointmentTable tbody");
      tbody.innerHTML = "";

      appointments.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.id}</td>
          <td>${a.appointmentTime.replace("T", " ")}</td>
          <td>${a.doctorId || "Ch∆∞a ch·ªâ ƒë·ªãnh"}</td>
          <td>${a.status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function closeAppointments() {
      document.getElementById("appointmentModal").style.display = "none";
    }
// üì® L·∫•y th√¥ng b√°o t·ª´ backend & hi·ªÉn th·ªã
async function loadNotifications() {
  const userId = localStorage.getItem("userId");
  if (!userId) return;

  try {
const response = await fetch(`http://localhost:8080/notification-service/api/notifications/user/${userId}`);
if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o");

let notifications = await response.json();
if (!Array.isArray(notifications)) notifications = [notifications];

    const listContainer = document.getElementById("notificationList");
    const badge = document.querySelector(".notification-badge");
    listContainer.innerHTML = "";

    if (notifications.length === 0) {
      listContainer.innerHTML = `<p style="padding:10px; text-align:center; color:#888;">Kh√¥ng c√≥ th√¥ng b√°o n√†o</p>`;
      badge.style.display = "none";
      return;
    }

    // üî¢ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ch∆∞a ƒë·ªçc
    const unreadCount = notifications.filter(n => n.read === false || n.read === "false").length;
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? "block" : "none";

    // üßæ Hi·ªÉn th·ªã danh s√°ch
    notifications
      .filter(n => n.read === false || n.read === "false")
      .slice(-10)
      .reverse()
      .forEach(noti => {
        const item = document.createElement("div");
        item.classList.add("dropdown-item");
        item.style.display = "flex";
        item.style.justifyContent = "space-between";
        item.style.alignItems = "center";
        item.innerHTML = `
          <div style="max-width:220px;">
            <i class="fa-solid fa-circle-info"></i>
            ${noti.message}<br>
            <small style="color:gray;">${new Date(noti.createdAt).toLocaleString()}</small>
          </div>
          <button class="mark-read-btn" title="ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc">‚úì</button>
        `;

        // Style n√∫t ‚úì
        const btn = item.querySelector(".mark-read-btn");
        btn.style.background = "#28a745";
        btn.style.color = "white";
        btn.style.border = "none";
        btn.style.borderRadius = "50%";
        btn.style.width = "22px";
        btn.style.height = "22px";
        btn.style.cursor = "pointer";
        btn.style.fontWeight = "bold";
        btn.style.transition = "0.2s";
        btn.addEventListener("mouseenter", () => btn.style.opacity = "0.8");
        btn.addEventListener("mouseleave", () => btn.style.opacity = "1");

        // Khi click ‚úì ‚Üí g·ªçi API PUT
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          try {
            await fetch(`http://localhost:8080/notification-service/api/notifications/${noti.id}/read`, {
              method: "PUT",
            });
            item.remove();
            const newCount = Math.max(parseInt(badge.textContent) - 1, 0);
            badge.textContent = newCount;
            if (newCount === 0) badge.style.display = "none";
          } catch (err) {
            console.error("L·ªói khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc:", err);
            alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√£ ƒë·ªçc!");
          }
        });

        listContainer.appendChild(item);
      });

    if (listContainer.children.length === 0) {
      listContainer.innerHTML = `<p style="padding:10px; text-align:center; color:#888;">Kh√¥ng c√≥ th√¥ng b√°o ch∆∞a ƒë·ªçc</p>`;
    }

  } catch (err) {
    console.error("L·ªói khi t·∫£i th√¥ng b√°o:", err);
    document.getElementById("notificationList").innerHTML =
      `<p style="padding:10px; color:red;">L·ªói t·∫£i th√¥ng b√°o</p>`;
  }
}

// üîÅ G·ªçi khi load trang & refresh m·ªói 10 gi√¢y
document.addEventListener("DOMContentLoaded", loadNotifications);
setInterval(loadNotifications, 10000);

  </script>
</body>
</html>
