<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·∫∑t L·ªãch Kh√°m - B∆∞·ªõc 4: X√°c Nh·∫≠n</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    .container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 800px;
      width: 100%;
      text-align: center;
    }
    h1 { font-size: 28px; color: #007bff; margin-bottom: 10px; }
    p.step-info { font-size: 16px; color: #6c757d; margin-bottom: 30px; }
    .confirmation-details {
      background-color: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
    }
    .detail-row {
      display: flex; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #e0e0e0;
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: bold; color: #495057; }
    .detail-value { color: #007bff; }
    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      font-size: 14px;
      color: #856404;
      text-align: left;
    }
    .navigation { display: flex; justify-content: space-between; margin-top: 30px; }
    .back-btn, .confirm-btn {
      background-color: #6c757d; color: white;
      border: none; padding: 12px 30px;
      font-size: 16px; border-radius: 8px;
      cursor: pointer; transition: background-color 0.3s ease;
    }
    .back-btn:hover { background-color: #545b62; }
    .confirm-btn { background-color: #28a745; }
    .confirm-btn:hover { background-color: #218838; }
    .success-message {
      display: none; background-color: #d4edda;
      border: 1px solid #c3e6cb; border-radius: 8px;
      padding: 20px; margin: 30px 0;
      color: #155724; font-size: 18px; font-weight: bold;
    }
    .success-details { margin-top: 20px; text-align: left; font-size: 16px; }
    .success-details p { margin: 10px 0; }
    @media (max-width: 600px) {
      .container { padding: 20px; }
      .navigation { flex-direction: column; gap: 10px; }
      .detail-row { flex-direction: column; }
      .detail-value { margin-top: 5px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ƒê·∫∑t L·ªãch Kh√°m B·ªánh</h1>
    <p class="step-info">B∆∞·ªõc 4: X√°c nh·∫≠n th√¥ng tin ƒë·∫∑t l·ªãch kh√°m. Vui l√≤ng ki·ªÉm tra k·ªπ tr∆∞·ªõc khi x√°c nh·∫≠n.</p>

    <div class="confirmation-details" id="confirmDetails">
      <h2 style="color: #007bff; margin-top: 0;">Th√¥ng tin ƒë·∫∑t l·ªãch</h2>
      <div class="detail-row"><span class="detail-label">Khoa kh√°m:</span><span class="detail-value" id="valDept">-</span></div>
      <div class="detail-row"><span class="detail-label">Ng√†y kh√°m:</span><span class="detail-value" id="valDate">-</span></div>
      <div class="detail-row"><span class="detail-label">Gi·ªù kh√°m:</span><span class="detail-value" id="valTime">-</span></div>
      <div class="detail-row"><span class="detail-label">B√°c sƒ©:</span><span class="detail-value" id="valDoctor">Ch∆∞a ch·ªâ ƒë·ªãnh</span></div>
      <div class="detail-row"><span class="detail-label">H·ªç v√† t√™n:</span><span class="detail-value" id="valPatient">-</span></div>
      <div class="detail-row"><span class="detail-label">Gi·ªõi t√≠nh:</span><span class="detail-value" id="valGender">-</span></div>
      <div class="detail-row"><span class="detail-label">S·ªë ƒëi·ªán tho·∫°i:</span><span class="detail-value" id="valPhone">-</span></div>
      <div class="detail-row"><span class="detail-label">ƒê·ªãa ch·ªâ:</span><span class="detail-value" id="valAddress">-</span></div>
    </div>

    <div class="warning" id="warningBox">
      <strong>L∆∞u √Ω:</strong> Vui l√≤ng ƒë·∫øn ƒë√∫ng gi·ªù ƒë√£ ƒë·∫∑t. N·∫øu c·∫ßn h·ªßy ho·∫∑c thay ƒë·ªïi l·ªãch, vui l√≤ng li√™n h·ªá b·ªánh vi·ªán √≠t nh·∫•t 24 gi·ªù tr∆∞·ªõc gi·ªù kh√°m.
    </div>

    <div class="navigation" id="navButtons">
      <button class="back-btn" onclick="goBack()">Quay L·∫°i B∆∞·ªõc 3</button>
      <button class="confirm-btn" id="confirmBtn">X√°c Nh·∫≠n ƒê·∫∑t L·ªãch</button>
    </div>

    <div class="success-message" id="successMessage">
      <h2 style="color: #28a745; margin-top: 0;">‚úÖ ƒê·∫∑t l·ªãch kh√°m th√†nh c√¥ng!</h2>
      <p>C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª• ƒë·∫∑t l·ªãch kh√°m c·ªßa ch√∫ng t√¥i.</p>
      <div class="success-details" id="successDetails"></div>
      <button class="back-btn" onclick="goHome()" style="margin-top: 20px;">Quay v·ªÅ Trang Ch·ªß</button>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(window.location.search);

  // --- D·ªØ li·ªáu b·ªánh nh√¢n v√† l·ªãch kh√°m ---
  const bookingData = {
    fullName: qs.get('fullName'),
    gender: qs.get('gender'),
    phone: qs.get('phone'),
    address: qs.get('address'),
    doctorId: qs.get('doctorId'),
    deptName: qs.get('deptName'),
    date: qs.get('date'),
    rawTime: qs.get('time')
  };

  // --- Chu·∫©n h√≥a gi·ªù ---
  bookingData.time = bookingData.rawTime ? bookingData.rawTime.split('-')[0].trim() : null;

  // --- Hi·ªÉn th·ªã x√°c nh·∫≠n ---
  function fillDetails() {
    document.getElementById('valDept').textContent = bookingData.deptName || '-';
    document.getElementById('valDate').textContent = bookingData.date || '-';
    document.getElementById('valTime').textContent = bookingData.rawTime || '-';
    document.getElementById('valDoctor').textContent = bookingData.doctorId || 'Ch∆∞a ch·ªâ ƒë·ªãnh';
    document.getElementById('valPatient').textContent = bookingData.fullName || '-';
    document.getElementById('valGender').textContent = bookingData.gender || '-';
    document.getElementById('valPhone').textContent = bookingData.phone || '-';
    document.getElementById('valAddress').textContent = bookingData.address || '-';
  }
  fillDetails();

  // --- Khi nh·∫•n X√°c nh·∫≠n ---
  document.getElementById('confirmBtn').addEventListener('click', async () => {
    try {
      console.log("üßæ D·ªØ li·ªáu bookingData:", bookingData);
      console.log("üßç userId trong localStorage:", localStorage.getItem('userId'));

      // 1Ô∏è‚É£ Chu·∫©n b·ªã d·ªØ li·ªáu b·ªánh nh√¢n
      const patientPayload = {
        fullName: bookingData.fullName,
        gender: bookingData.gender,
        phone: bookingData.phone,
        address: bookingData.address,
        user: { id: localStorage.getItem('userId') }
      };

      console.log("üì¶ patientPayload g·ª≠i ƒëi:", patientPayload);

      // 2Ô∏è‚É£ G·ª≠i POST ƒë·∫øn user-service
      const patientRes = await fetch("http://localhost:8080/user-service/api/patients", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json;charset=UTF-8"
        },
        body: JSON.stringify(patientPayload)
      });

      console.log("üì® Response status:", patientRes.status);
      const textRes = await patientRes.text();
      console.log("üì® Response body:", textRes);

      if (!patientRes.ok) throw new Error("Kh√¥ng th·ªÉ l∆∞u b·ªánh nh√¢n");

      const savedPatient = JSON.parse(textRes);
      console.log("‚úÖ B·ªánh nh√¢n ƒë√£ l∆∞u:", savedPatient);

      // 3Ô∏è‚É£ T·∫°o l·ªãch h·∫πn sau khi c√≥ b·ªánh nh√¢n
      const appointmentPayload = {
        patientId: savedPatient.id,
        doctorId: bookingData.doctorId || null,
        appointmentTime: `${bookingData.date}T${bookingData.time}:00`,
        status: "REGISTERED"
      };

      console.log("üìÖ appointmentPayload g·ª≠i ƒëi:", appointmentPayload);

      const apptRes = await fetch("http://localhost:8080/appointment-service/api/appointments", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json;charset=UTF-8"
        },
        body: JSON.stringify(appointmentPayload)
      });

      const apptText = await apptRes.text();
      console.log("üì® Response appointment:", apptText);

      if (!apptRes.ok) throw new Error("Kh√¥ng th·ªÉ l∆∞u l·ªãch h·∫πn");

      const savedAppt = JSON.parse(apptText);
      console.log("‚úÖ L·ªãch h·∫πn ƒë√£ l∆∞u:", savedAppt);

      // 4Ô∏è‚É£ Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
      document.getElementById('confirmDetails').style.display = 'none';
      document.getElementById('navButtons').style.display = 'none';
      document.getElementById('warningBox').style.display = 'none';
      document.getElementById('successMessage').style.display = 'block';

      document.getElementById('successDetails').innerHTML = `
        <p><strong>M√£ l·ªãch h·∫πn:</strong> <span style="color:#007bff;">${savedAppt.id}</span></p>
        <p><strong>Th·ªùi gian:</strong> ${bookingData.rawTime}, ng√†y ${bookingData.date}</p>
        <p><strong>Khoa:</strong> ${bookingData.deptName}</p>
        <p><strong>B·ªánh nh√¢n:</strong> ${savedPatient.fullName}</p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${savedPatient.phone}</p>
      `;
    } catch (err) {
      alert("‚ùå C√≥ l·ªói khi ƒë·∫∑t l·ªãch! " + err.message);
      console.error("üö® L·ªói chi ti·∫øt:", err);
    }
  });

  function goBack() {
    window.location.href = `./thongtin?${qs.toString()}`;
  }

  function goHome() {
    window.location.href = `./home`;
  }
</script>