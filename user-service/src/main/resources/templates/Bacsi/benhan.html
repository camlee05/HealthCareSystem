<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·ªánh √°n - H·ªá th·ªëng B·ªánh vi·ªán</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #1f2937;
      margin-bottom: 30px;
    }
    .section {
      background: #f9fafb;
      border-left: 5px solid #4facfe;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      color: #2563eb;
      margin-bottom: 10px;
    }
    p {
      margin: 6px 0;
      color: #374151;
      line-height: 1.6;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.9rem;
      color: white;
      margin-left: 5px;
    }
    .badge-info { background: #3b82f6; }
    .badge-warning { background: #f59e0b; }
    .badge-success { background: #10b981; }
    .badge-danger { background: #ef4444; }
    .btn {
      display: inline-block;
      background: #4facfe;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      margin-right: 10px;
    }
    .btn:hover { background: #3b82f6; }
    .back-btn { background: #6b7280; }
    .back-btn:hover { background: #4b5563; }
    .actions { text-align: center; margin-top: 25px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Th√¥ng Tin B·ªánh √Ån</h1>

    <div id="patientSection" class="section">
      <h2>üë§ Th√¥ng tin b·ªánh nh√¢n</h2>
      <p><strong>M√£ BN:</strong> <span id="patientCode">‚Äî</span></p>
      <p><strong>H·ªç t√™n:</strong> <span id="patientName">‚Äî</span></p>
      <p><strong>Gi·ªõi t√≠nh:</strong> <span id="patientGender">‚Äî</span></p>
      <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="patientPhone">‚Äî</span></p>
      <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="patientAddress">‚Äî</span></p>
    </div>

    <div id="appointmentSection" class="section">
      <h2>üìÖ L·ªãch h·∫πn</h2>
      <p><strong>Th·ªùi gian kh√°m:</strong> <span id="appointmentTime">‚Äî</span></p>
      <p><strong>B√°c sƒ© ph·ª• tr√°ch:</strong> <span id="doctorId">‚Äî</span></p>
      <p><strong>Tr·∫°ng th√°i:</strong> <span id="appointmentStatus" class="badge badge-info">‚Äî</span></p>
    </div>

    <div id="diagnosisSection" class="section">
      <h2>ü©∫ K·∫øt qu·∫£ kh√°m</h2>
      <p><strong>Ch·∫©n ƒëo√°n:</strong> <span id="diagnosisResult">‚Äî</span></p>
      <p><strong>ƒêi·ªÅu tr·ªã:</strong> <span id="treatmentText">‚Äî</span></p>
      <p><strong>Ghi ch√∫:</strong> <span id="diagnosisNotes">‚Äî</span></p>
    </div>

    <div class="actions">
      <button class="btn back-btn" onclick="window.location.href='/bacsi/lichkham'">‚¨ÖÔ∏è Quay l·∫°i</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è In b·ªánh √°n</button>
    </div>
  </div>

<script>
  const API_PATIENTS = "http://localhost:8080/user-service/api/patients";
  const API_APPOINTMENTS = "http://localhost:8080/appointment-service/api/appointments";
  const API_DIAGNOSES = "http://localhost:8080/diagnosis-service/api/diagnoses";
  const API_USERS = "http://localhost:8080/user-service/api/users";

  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const diagnosisId = params.get("diagnosisId");

    if (!diagnosisId) {
      alert("Kh√¥ng c√≥ m√£ b·ªánh √°n trong URL!");
      return;
    }

    try {
      // 1Ô∏è‚É£ L·∫•y th√¥ng tin b·ªánh √°n theo diagnosisId
      const diagRes = await fetch(`${API_DIAGNOSES}/${diagnosisId}`);
      if (!diagRes.ok) throw new Error("Kh√¥ng t√¨m th·∫•y b·ªánh √°n!");
      const diag = await diagRes.json();

      // 2Ô∏è‚É£ L·∫•y th√¥ng tin b·ªánh nh√¢n
      const patientRes = await fetch(`${API_PATIENTS}/${diag.patientId}`);
      if (!patientRes.ok) throw new Error("Kh√¥ng t√¨m th·∫•y b·ªánh nh√¢n!");
      const patient = await patientRes.json();

      document.getElementById("patientCode").textContent = patient.code || "-";
      document.getElementById("patientName").textContent = patient.fullName || "-";
      document.getElementById("patientGender").textContent = patient.gender === "female" ? "N·ªØ" : "Nam";
      document.getElementById("patientPhone").textContent = patient.phone || "-";
      document.getElementById("patientAddress").textContent = patient.address || "-";

      // 3Ô∏è‚É£ L·∫•y th√¥ng tin l·ªãch h·∫πn
      const apptRes = await fetch(`${API_APPOINTMENTS}/${diag.appointmentId}`);
      if (apptRes.ok) {
        const appt = await apptRes.json();
        document.getElementById("appointmentTime").textContent =
          new Date(appt.appointmentTime).toLocaleString("vi-VN");
        const statusEl = document.getElementById("appointmentStatus");
        statusEl.textContent = appt.status;
        statusEl.className =
          "badge " +
          {
            REGISTERED: "badge-info",
            SCHEDULED: "badge-warning",
            ONGOING: "badge-warning",
            COMPLETED: "badge-success",
            CANCELED: "badge-danger",
          }[appt.status];
      }

      // 4Ô∏è‚É£ L·∫•y t√™n b√°c sƒ© (t·ª´ user-service)
      if (diag.doctorId) {
        try {
          const doctorRes = await fetch(`${API_USERS}/${diag.doctorId}`);
          if (doctorRes.ok) {
            const doctor = await doctorRes.json();
            document.getElementById("doctorId").textContent =
              doctor.fullName || doctor.username || "Kh√¥ng x√°c ƒë·ªãnh";
          } else {
            document.getElementById("doctorId").textContent = "Kh√¥ng x√°c ƒë·ªãnh";
          }
        } catch {
          document.getElementById("doctorId").textContent = "Kh√¥ng x√°c ƒë·ªãnh";
        }
      }

      // 5Ô∏è‚É£ Hi·ªÉn th·ªã k·∫øt qu·∫£ chu·∫©n ƒëo√°n
      document.getElementById("diagnosisResult").textContent = diag.result || "‚Äî";
      document.getElementById("treatmentText").textContent = diag.treatmentText || "‚Äî";
      document.getElementById("diagnosisNotes").textContent = diag.notes || "‚Äî";

    } catch (err) {
      console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu:", err);
      alert(err.message || "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b·ªánh √°n!");
    }
  });
</script>

</body>
</html>
