<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Th√¥ng Tin B·ªánh Nh√¢n</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
      padding: 30px;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: #1a3c64;
      font-size: 28px;
      margin-bottom: 20px;
      text-align: center;
      position: relative;
    }

    h1::after {
      content: '';
      width: 50px;
      height: 4px;
      background: #2196f3;
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 2px;
    }

    .info-section {
      background: #f5faff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .medical-record {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .medical-record:hover {
      transform: scale(1.02);
      background: #dbeafe;
    }

    button {
      background: #2196f3;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
      margin: 5px;
    }

    button:hover {
      background: #1976d2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .back-btn {
      background: #6c757d;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .loading, .error {
      text-align: center;
      color: #555;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Th√¥ng Tin B·ªánh Nh√¢n</h1>
    <div id="patientInfo" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div id="medicalRecords"></div>
    <button onclick="goToNext()">Ti·∫øp Theo</button>
    <button class="back-btn" onclick="goToBack()">Quay L·∫°i</button>
  </div>

<script>
  // ==========================
  // üîó API GATEWAY ENDPOINTS
  // ==========================
  const API_PATIENT = "http://localhost:8080/user-service/api/patients";
  const API_DIAGNOSIS = "http://localhost:8080/diagnosis-service/api/diagnoses";

  // ==========================
  // ‚öôÔ∏è L·∫•y patientId (t·ª´ URL ho·∫∑c userId)
  // ==========================
  const urlParams = new URLSearchParams(window.location.search);
  let patientId = urlParams.get("id");

  // N·∫øu kh√¥ng c√≥ ?id=... th√¨ t·ª± t√¨m b·∫±ng userId trong localStorage
  async function ensurePatientId() {
    if (!patientId) {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        alert("Kh√¥ng c√≥ th√¥ng tin ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
        window.location.href = "/login";
        return;
      }

      try {
        const res = await fetch(`${API_PATIENT}/user/${userId}`);
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y b·ªánh nh√¢n v·ªõi userId n√†y!");
        const patient = await res.json();
        patientId = patient.id;
        console.log("‚úÖ L·∫•y ƒë∆∞·ª£c patientId:", patientId);
      } catch (err) {
        console.error("‚ùå L·ªói khi l·∫•y patientId:", err);
        alert("Kh√¥ng c√≥ m√£ b·ªánh nh√¢n trong URL v√† kh√¥ng th·ªÉ l·∫•y t·ª´ userId!");
      }
    }
  }

  // ==========================
  // ‚öôÔ∏è Load d·ªØ li·ªáu b·ªánh nh√¢n + chu·∫©n ƒëo√°n
  // ==========================
  async function loadPatientInfo() {
    await ensurePatientId(); // ‚úÖ ƒë·∫£m b·∫£o ƒë√£ c√≥ patientId

    const infoDiv = document.getElementById("patientInfo");
    const recordDiv = document.getElementById("medicalRecords");

    if (!patientId) {
      infoDiv.innerHTML = `<p class="error">Kh√¥ng t√¨m th·∫•y ID b·ªánh nh√¢n!</p>`;
      return;
    }

    try {
      // üîπ L·∫•y th√¥ng tin b·ªánh nh√¢n
      const patientRes = await fetch(`${API_PATIENT}/${patientId}`);
      if (!patientRes.ok) throw new Error("Kh√¥ng t√¨m th·∫•y th√¥ng tin b·ªánh nh√¢n!");
      const patient = await patientRes.json();

      infoDiv.innerHTML = `
        <div class="info-section">
          <h2>${patient.fullName}</h2>
          <p><strong>M√£ BN:</strong> ${patient.code || "-"}</p>
          <p><strong>Gi·ªõi t√≠nh:</strong> ${patient.gender === "female" ? "N·ªØ" : "Nam"}</p>
          <p><strong>SƒêT:</strong> ${patient.phone || "-"}</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> ${patient.address || "-"}</p>
        </div>
      `;

      // üîπ L·∫•y danh s√°ch b·ªánh √°n / chu·∫©n ƒëo√°n
      const diagRes = await fetch(`${API_DIAGNOSIS}/patient/${patientId}`);
      if (!diagRes.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu chu·∫©n ƒëo√°n!");
      const diagnoses = await diagRes.json();

      console.log("ü©∫ Danh s√°ch b·ªánh √°n:", diagnoses);

      let html = "<h3>B·ªánh √Ån / L·ªãch S·ª≠ Chu·∫©n ƒêo√°n:</h3>";
      if (diagnoses.length > 0) {
        diagnoses.forEach(diag => {
          const date = diag.date
            ? new Date(diag.date).toLocaleDateString("vi-VN")
            : "Kh√¥ng x√°c ƒë·ªãnh";

          // ‚úÖ D√πng ƒë√∫ng thu·ªôc t√≠nh ID th·ª±c t·∫ø
          const diagnosisId = diag.id || diag.diagnosisId || diag._id;
          if (!diagnosisId) {
            console.warn("‚ö†Ô∏è B·ªánh √°n kh√¥ng c√≥ ID h·ª£p l·ªá:", diag);
            return;
          }

          html += `
            <div class="medical-record" onclick="goToBenhan('${diagnosisId}')">
              <p><strong>Ng√†y kh√°m:</strong> ${date}</p>
              <p><strong>Chu·∫©n ƒëo√°n:</strong> ${diag.result || "Ch∆∞a c√≥ chu·∫©n ƒëo√°n"}</p>
              <p><strong>ƒêi·ªÅu tr·ªã:</strong> ${diag.treatmentText || "Kh√¥ng c√≥"}</p>
              <p><strong>Ghi ch√∫:</strong> ${diag.notes || "Kh√¥ng c√≥"}</p>
            </div>
          `;
        });
      } else {
        html += `<p>Ch∆∞a c√≥ b·ªánh √°n ho·∫∑c chu·∫©n ƒëo√°n n√†o.</p>`;
      }

      recordDiv.innerHTML = html;

    } catch (err) {
      console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
      infoDiv.innerHTML = `<p class="error">${err.message}</p>`;
    }
  }

  // ==========================
  // üîô ƒêi·ªÅu h∆∞·ªõng
  // ==========================
  function goToNext() {
    if (!patientId) {
      alert("Kh√¥ng c√≥ m√£ b·ªánh nh√¢n ƒë·ªÉ th√™m b·ªánh √°n!");
      return;
    }
    window.location.href = `/bacsi/addbenhan?id=${encodeURIComponent(patientId)}`;
  }

  function goToBack() {
    window.location.href = '/bacsi/lichkham';
  }

  function goToNext() {
      window.location.href = `/bacsi/addbenhan?id=${patientId}`;
    }

    function goToBenhan(diagnosisId) {
    window.location.href = `http://localhost:8080/bacsi/xembenhan?diagnosisId=${diagnosisId}`;
  }

  // ==========================
  // üöÄ Khi load xong trang
  // ==========================
  document.addEventListener("DOMContentLoaded", loadPatientInfo);
</script>

</body>
</html>
